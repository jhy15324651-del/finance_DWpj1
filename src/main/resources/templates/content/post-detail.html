<!-- =======================
      HEADER
======================= -->
<th:block th:replace="content/layout/header :: header"></th:block>
<th:block th:replace="content/layout/header :: bodyheader"></th:block>

<div class="post-detail-container">

    <!-- =======================
          제목
    ======================== -->
    <h1 class="post-detail-title" th:text="${post.title}"></h1>

    <!-- =======================
          평균 평점 표시
    ======================== -->
    <div class="post-rating-box" th:if="${ratingCount > 0}">
        <div class="rating-stars-display">
            <span th:each="i : ${#numbers.sequence(1,5)}"
                  th:classappend="
                    ${avgRating >= i} ? 'full' :
                    (${avgRating >= i - 0.5} ? 'half' : '')
                  ">
            </span>
        </div>

        <div class="rating-average-text">
            <span th:text="${avgRating}"></span> / 5.0
            (<span th:text="${ratingCount}"></span>명)
        </div>
    </div>

    <!-- 날짜 / 조회수 / 작성자 -->
    <div class="post-detail-meta">
        <div>
            <span th:text="${#temporals.format(post.createdDate,'yyyy.MM.dd')}"></span>
            · 조회수 <span th:text="${post.viewCount}"></span>
        </div>
        <b th:text="${post.writer != null ? post.writer : '익명'}"></b>
    </div>

    <!-- 이미지 -->
    <div th:if="${post.imgUrl}" class="post-image-box">
        <img th:src="${post.imgUrl}" class="post-image">
    </div>

    <!-- 본문 -->
    <div class="post-detail-content" th:utext="${post.content}"></div>

    <!-- 해시태그 -->
    <div class="post-hashtags"
         th:if="${post.hashtags != null and #strings.length(post.hashtags) > 0}">
        <span th:each="tag : ${#strings.arraySplit(post.hashtags, ' ')}">
            <a th:href="@{/content/category(keyword=${tag})}"
               class="tag-item tag-badge"
               th:text="${tag}">
            </a>
        </span>
    </div>

    <!-- =======================
         게시글 수정/삭제
    ======================== -->
    <div class="post-edit-buttons"
         th:if="${nickname != null and post.writer == nickname}">
        <a th:href="@{/content/edit/{id}(id=${post.id})}" class="btn btn-outline-primary">수정</a>
        <a th:href="@{/content/delete/{id}(id=${post.id})}"
           class="btn btn-outline-danger"
           onclick="return confirm('정말 삭제하시겠습니까?');">삭제</a>
    </div>

    <!-- =======================
          댓글 목록
    ======================== -->
    <div class="comment-section">
        <h3 class="comment-title">댓글</h3>

        <div class="comment-list">
            <div th:each="c : ${comments}" class="comment-item-box">

                <!-- 댓글 header -->
                <div class="comment-header">
                    <b class="comment-writer" th:text="${c.writer}"></b>
                    <span class="comment-date"
                          th:text="${#temporals.format(c.createdDate,'yyyy-MM-dd HH:mm')}"></span>
                </div>

                <!-- ⭐ 댓글 평점 표시 -->
                <div class="comment-rating" th:if="${c.rating != null}">
                    <div class="rating-stars-display small"
                         th:attr="data-rating=${c.rating}">
                        <span th:each="i : ${#numbers.sequence(1,5)}"
                              th:classappend="
                                ${c.rating >= i} ? 'full' :
                                (${c.rating >= i - 0.5} ? 'half' : '')
                              ">
                        </span>
                    </div>
                </div>

                <!-- 댓글 내용 -->
                <div class="comment-text" th:text="${c.content}"></div>

                <!-- 액션 버튼 -->
                <div class="comment-actions">
                    <button th:if="${nickname == c.writer}"
                            class="comment-edit-btn"
                            th:attr="data-id=${c.id}, data-rating=${c.rating}">
                        수정
                    </button>

                    <button th:if="${nickname == c.writer || nickname == post.writer}"
                            class="comment-delete-btn"
                            th:attr="data-id=${c.id}">
                        삭제
                    </button>
                </div>

            </div>
        </div>

        <!-- =======================
              댓글 작성
        ======================== -->
        <div class="comment-write-box">

            <div th:if="${nickname == null}" class="comment-login-required">
                <p>댓글을 작성하려면 <a href="/user/login">로그인</a>이 필요합니다.</p>
            </div>

            <div th:if="${nickname != null}" class="comment-write-row">

                <!-- 작성자 + 별점 한 줄 -->
                <div class="comment-write-top">
                    <div class="writer-box">
                        <b>작성자:</b> <span th:text="${nickname}"></span>
                    </div>

                    <!-- ⭐ 평점 입력 -->
                    <div class="rating-stars" id="rating-stars">
                        <span></span><span></span><span></span><span></span><span></span>
                    </div>
                </div>

                <!-- 입력창 + 등록 버튼 -->
                <div class="comment-write-bottom">
                    <textarea id="comment-content" class="comment-textarea"
                              placeholder="타인을 비방하거나 명예를 훼손하는 댓글은 제재될 수 있습니다."></textarea>

                    <button id="comment-submit" class="comment-submit-btn">등록</button>
                </div>

            </div>
        </div>

    </div> <!-- 댓글 섹션 END -->



    <!-- =======================
         목록 / 홈 버튼
    ======================== -->
    <div class="detail-btn-container">
        <a th:href="@{/content/category(page=${page},keyword=${keyword},searchType=${searchType})}"
           class="btn btn-outline-secondary detail-btn">목록으로</a>

        <a th:href="@{/content/}" class="btn btn-outline-secondary detail-btn">홈으로</a>
    </div>

</div> <!-- container END -->


<!-- =======================
     ⭐ SCRIPT (별점 + 댓글)
======================= -->
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {

        /* ---------------------------------------------------------
            ⭐ 댓글 작성 별점 입력 (0.5 단위)
        --------------------------------------------------------- */
        let selectedRating = 0;
        const inputStars = document.querySelectorAll("#rating-stars span");

        function renderInputStars(rating) {
            inputStars.forEach((star, index) => {
                star.classList.remove("full", "half");
                const val = index + 1;
                if (rating >= val) star.classList.add("full");
                else if (rating >= val - 0.5) star.classList.add("half");
            });
        }

        inputStars.forEach((star, index) => {
            star.addEventListener("click", e => {
                const rect = star.getBoundingClientRect();
                const half = (e.clientX - rect.left) <= rect.width / 2;
                selectedRating = index + (half ? 0.5 : 1.0);
                renderInputStars(selectedRating);
            });
        });

        /* ---------------------------------------------------------
            댓글 작성 요청
        --------------------------------------------------------- */
        const submitBtn = document.getElementById("comment-submit");

        if (submitBtn) {
            submitBtn.addEventListener("click", async () => {

                const content = document.getElementById("comment-content").value;
                const postId = [[${post.id}]];

                if (!content.trim()) {
                    alert("댓글 내용을 입력해주세요.");
                    return;
                }

                // ⭐ 추가: 평점 미선택 시 등록 불가
                if (selectedRating === 0) {
                    alert("평점을 선택해주세요.");
                    return;
                }

                const res = await fetch("/content/comment", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        postId: postId,
                        content: content,
                        rating: selectedRating || 0
                    })
                });

                const result = await res.text();

                if (result === "SUCCESS") location.reload();
                else if (result === "NOT_LOGIN") alert("로그인이 필요합니다.");
                else alert("댓글 등록 실패");
            });
        }


        /* ---------------------------------------------------------
            댓글 삭제
        --------------------------------------------------------- */
        document.querySelectorAll(".comment-delete-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                const id = btn.dataset.id;
                if (!confirm("정말 삭제하시겠습니까?")) return;

                const res = await fetch(`/content/comment/${id}`, {method:"DELETE"});
                const result = await res.text();

                if (result === "SUCCESS") location.reload();
                else if (result === "NO_PERMISSION") alert("삭제 권한이 없습니다.");
                else alert("삭제 실패");
            });
        });

        /* ---------------------------------------------------------
            ⭐ 댓글 수정 + 기존 평점 변경 기능 (핵심)
        --------------------------------------------------------- */
        document.querySelectorAll(".comment-edit-btn").forEach(btn => {

            btn.addEventListener("click", () => {

                const id = btn.dataset.id;
                let editRating = parseFloat(btn.dataset.rating || 0);

                const box = btn.closest(".comment-item-box");
                const contentDiv = box.querySelector(".comment-text");

                const oldText = contentDiv.innerText;

                /* 액션 버튼 숨기기 */
                box.querySelectorAll(".comment-actions button")
                    .forEach(b => b.style.display = "none");

                /* 기존 별 UI */
                const ratingBox = box.querySelector(".rating-stars-display.small");
                const editStars = ratingBox.querySelectorAll("span");

                /* 댓글 내용 → textarea로 변경 */
                contentDiv.innerHTML = `
                <textarea class="edit-area">${oldText}</textarea>

                <div class="edit-action-wrapper">
                    <button class="save-edit-btn">저장</button>
                    <button class="cancel-edit-btn">취소</button>
                </div>
            `;

                /* 기존 표시용 별을 클릭 가능하도록 변경 */
                ratingBox.style.cursor = "pointer";

                function renderEditStars(rating) {
                    editStars.forEach((star, index) => {
                        star.classList.remove("full", "half");

                        const val = index + 1;
                        if (rating >= val) star.classList.add("full");
                        else if (rating >= val - 0.5) star.classList.add("half");
                    });
                }

                /* 초기 별 반영 */
                renderEditStars(editRating);

                /* ⭐ 클릭하면 평점 변경 */
                editStars.forEach((star, index) => {
                    star.addEventListener("click", e => {
                        const rect = star.getBoundingClientRect();
                        const half = (e.clientX - rect.left) <= rect.width / 2;

                        editRating = index + (half ? 0.5 : 1.0);
                        renderEditStars(editRating);
                    });
                });

                /* 저장 */
                contentDiv.querySelector(".save-edit-btn")
                    .addEventListener("click", async () => {

                        const newText = contentDiv.querySelector(".edit-area").value;

                        const res = await fetch(`/content/comment/${id}`, {
                            method: "PUT",
                            headers: {"Content-Type":"application/json"},
                            body: JSON.stringify({
                                content: newText,
                                rating: editRating
                            })
                        });

                        const result = await res.text();
                        if (result === "SUCCESS") location.reload();
                        else alert("수정 실패");
                    });

                /* 취소 */
                contentDiv.querySelector(".cancel-edit-btn")
                    .addEventListener("click", () => location.reload());
            });
        });

    });
</script>

<style>

    /* =====================
     본문 정보
====================== */
    .post-detail-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
        margin-bottom: 20px;
        color: #555;
        font-size: 14px;
    }

    .post-detail-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .post-image {
        max-width: 100%;
        border-radius: 6px;
        margin: 20px 0;
    }

    .post-detail-content {
        font-size: 16px;
        line-height: 1.7;
        margin-bottom: 40px;
        white-space: pre-line;
    }

    .post-hashtags {
        padding-bottom: 20px;
        border-bottom: 1px solid #e5e5e5;
        margin-bottom: 40px;
    }


    /* =====================
       ⭐ 평균 평점 표시
    ====================== */
    .post-rating-box {
        margin: 10px 0 15px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .rating-stars-display {
        display: flex;
        gap: 2px;
    }

    .rating-stars-display span {
        width: 22px;
        height: 22px;
        background: url('/img/star-empty.svg') center/cover no-repeat;
    }

    .rating-stars-display span.full {
        background-image: url('/img/star-full.svg');
    }

    .rating-stars-display span.half {
        background-image: url('/img/star-half.svg');
    }

    /* small 버전 (댓글용) */
    .rating-stars-display.small span {
        width: 18px;
        height: 18px;
    }

    /* ⭐ 댓글 수정 시 클릭 가능하게 (필수) */
    .rating-stars-display.small.editable span {
        cursor: pointer !important;
    }


    .rating-average-text {
        color: #555;
        font-size: 15px;
    }


    /* =====================
       댓글 목록
    ====================== */
    .comment-section {
        margin-top: 50px;
    }

    .comment-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 20px;
    }

    .comment-item-box {
        background: #fafafa;
        border-radius: 8px;
        padding: 18px;
        margin-bottom: 15px;
        border: 1px solid #eee;
        transition: border 0.2s, background 0.2s;
    }

    .comment-item-box:hover {
        border-color: #ddd;
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 14px;
        color: #555;
    }

    .comment-text {
        margin: 10px 0;
        font-size: 15px;
        color: #333;
    }

    .comment-actions button {
        margin-right: 6px;
    }


    /* =====================
       수정/삭제 버튼
    ====================== */
    .comment-edit-btn,
    .comment-delete-btn {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
        border: none;
    }

    .comment-edit-btn {
        background: #4e73df;
        color: #fff;
    }

    .comment-edit-btn:hover {
        background: #3b5cc4;
    }

    .comment-delete-btn:hover {
        background: #d0d0d0;
    }


    /* =====================
         댓글 수정 UI
    ====================== */

    /* textarea */
    .edit-area {
        width: 100%;
        min-height: 70px;
        padding: 12px;
        margin-top: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
        resize: vertical;
    }

    /* action 버튼들 */
    .edit-action-wrapper {
        display: flex;
        gap: 10px;
        margin-top: 12px;
    }

    .save-edit-btn {
        background: #4e73df;
        color: #fff;
        padding: 8px 14px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
    }

    .save-edit-btn:hover {
        background: #3b5cc4;
    }

    .cancel-edit-btn {
        background: #e5e5e5;
        padding: 8px 14px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
    }

    .cancel-edit-btn:hover {
        background: #d0d0d0;
    }


    /* =====================
       댓글 작성 UI
    ====================== */
    .comment-write-box {
        margin-top: 30px;
        border-top: 1px solid #e5e5e5;
        padding-top: 25px;
    }

    .comment-write-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .writer-box {
        font-size: 15px;
        color: #444;
    }

    /* ⭐ 신규 댓글 평점 입력 */
    .rating-stars {
        display: flex;
        gap: 4px;
        cursor: pointer;
    }

    .rating-stars span {
        width: 28px;
        height: 28px;
        background: url('/img/star-empty.svg') center/cover no-repeat;
    }

    .rating-stars span.full {
        background-image: url('/img/star-full.svg');
    }

    .rating-stars span.half {
        background-image: url('/img/star-half.svg');
    }

    .comment-write-bottom {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .comment-textarea {
        width: 100%;
        height: 70px;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
    }

    /* 작성자 + 별점 정렬 */
    .comment-write-top {
        width: 90%;
    }

    .comment-submit-btn {
        padding: 12px 18px;
        background: #4e73df;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        flex-shrink: 0;
        font-size: 14px;
    }


    /* =====================
       목록/홈 버튼
    ====================== */
    .detail-btn-container {
        margin-top: 40px;
        display: flex;
        gap: 10px;
    }

    /* 모바일 대응 */
    @media (max-width: 600px) {
        .post-detail-title {
            font-size: 22px;
        }
        .comment-textarea {
            height: 60px;
        }
        .rating-stars span {
            width: 24px;
            height: 24px;
        }
    }

</style>

<!-- FOOTER -->
<th:block th:replace="content/layout/footer :: footer"></th:block>