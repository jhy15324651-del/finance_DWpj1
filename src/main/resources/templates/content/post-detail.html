<!-- header -->
<th:block th:replace="content/layout/header :: header"></th:block>
<th:block th:replace="content/layout/header :: bodyheader"></th:block>

<div class="post-detail-container">

    <!-- ì œëª© -->
    <h1 class="post-detail-title" th:text="${post.title}"></h1>

    <!-- ë‚ ì§œ Â· ì¡°íšŒìˆ˜ + ì‘ì„±ì (ìš°ì¸¡ ì •ë ¬) -->
    <div class="post-detail-meta" style="display:flex; justify-content:space-between; align-items:center;">

        <!-- ë‚ ì§œ Â· ì¡°íšŒìˆ˜ -->
        <div>
            <span th:text="${#temporals.format(post.createdDate, 'yyyy.MM.dd')}"></span>
            <span class="view-text">
            Â· ì¡°íšŒìˆ˜ <span th:text="${post.viewCount}"></span>
        </span>
        </div>

        <!-- ì‘ì„±ì (ì˜¤ë¥¸ìª½ ë, bold) -->
        <div>
            <b th:text="${post.writer != null ? post.writer : 'ìµëª…'}"></b>
        </div>
    </div>


    <!-- ì´ë¯¸ì§€ -->
    <div th:if="${post.imgUrl}" class="post-image-box">
        <img th:src="${post.imgUrl}" class="post-image">
    </div>

    <!-- ë³¸ë¬¸ -->
    <div class="post-detail-content" th:utext="${post.content}"></div>

    <!-- í•´ì‹œíƒœê·¸ -->
    <div class="post-hashtags"
         th:if="${post.hashtags != null and #strings.length(post.hashtags) > 0}">
        <span th:each="tag : ${#strings.arraySplit(post.hashtags, ' ')}">
            <a th:href="@{/content/category(keyword=${tag})}"
               class="tag-item tag-badge"
               th:text="${tag}">
            </a>
        </span>
    </div>

    <!-- ëŒ“ê¸€ ì˜ì—­ -->
    <div class="comment-section">

        <h3 class="comment-title">ëŒ“ê¸€</h3>

        <div class="comment-list">
            <div th:each="c : ${comments}" class="comment-item-box">

                <!-- ì¼ë°˜ ëŒ“ê¸€ -->
                <div th:if="${c.parentId == null}">
                    <div class="comment-header">
                        <b class="comment-writer" th:text="${c.writer}"></b>
                        <span class="comment-date"
                              th:text="${#temporals.format(c.createdDate, 'yyyy-MM-dd HH:mm')}"></span>
                    </div>

                    <div class="comment-text" th:text="${c.content}"></div>

                    <div class="comment-actions">
                        <button class="reply-btn" th:attr="data-id=${c.id}">ë‹µê¸€ì“°ê¸°</button>

                        <!-- ëŒ“ê¸€ ì‚­ì œ ë²„íŠ¼ (ì‘ì„±ì & ê²Œì‹œê¸€ ì‘ì„±ìë§Œ) -->
                        <button class="comment-delete-btn" th:attr="data-id=${c.id}">ì‚­ì œ</button>
                    </div>
                </div>

                <!-- ëŒ€ëŒ“ê¸€ -->
                <div th:if="${c.parentId != null}" class="reply-item">
                    <div class="comment-header">
                        â†³ <b class="comment-writer" th:text="${c.writer}"></b>
                        <span class="comment-date"
                              th:text="${#temporals.format(c.createdDate, 'yyyy-MM-dd HH:mm')}"></span>
                    </div>

                    <div class="comment-text" th:text="${c.content}"></div>

                    <div class="comment-actions">
                        <button class="comment-delete-btn" th:attr="data-id=${c.id}">ì‚­ì œ</button>
                    </div>
                </div>

            </div>
        </div>

        <!-- ëŒ“ê¸€ ì‘ì„± ì˜ì—­ (íšŒì› ì „ìš©) -->
        <div class="comment-write-box">

            <h4 class="comment-write-title">ëŒ“ê¸€ ì‘ì„±</h4>

            <!-- ë¡œê·¸ì¸ x -->
            <div th:if="${nickname == null}" class="comment-login-required">
                <p>ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="/user/login">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            </div>

            <!-- ë¡œê·¸ì¸ O -->
            <div th:if="${nickname != null}" class="comment-write-row">

                <div class="comment-nickname-box">
                    <b>ì‘ì„±ì: </b> <span th:text="${nickname}"></span>
                </div>

                <textarea id="comment-content" class="comment-textarea"
                          placeholder="íƒ€ì¸ì„ ë¹„ë°©í•˜ê±°ë‚˜ ëª…ì˜ˆë¥¼ í›¼ì†í•˜ëŠ” ëŒ“ê¸€ì€ ì œì¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤."></textarea>

                <div class="comment-submit-wrap">
                    <button id="comment-submit" class="comment-submit-btn">ë“±ë¡</button>
                </div>
            </div>
        </div>

    </div>

    <!-- ëª©ë¡ ë²„íŠ¼ -->
    <div class="detail-btn-container">
        <a th:href="@{/content/category(page=${page}, keyword=${keyword}, searchType=${searchType})}"
           class="btn btn-outline-secondary detail-btn">
            ëª©ë¡ìœ¼ë¡œ
        </a>

        <a th:href="@{/content/}"
           class="btn btn-outline-secondary detail-btn">
            í™ˆìœ¼ë¡œ
        </a>
    </div>

</div>

<!-- ëŒ“ê¸€ ì‘ì„± AJAX -->
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        // ğŸ”¥ ëŒ“ê¸€ ë“±ë¡ ë²„íŠ¼ ìš”ì†Œ ì°¾ê¸°
        const submitBtn = document.getElementById("comment-submit");
        if (!submitBtn) return;   // ë²„íŠ¼ì´ ì—†ìœ¼ë©´ ì‹¤í–‰ ì¤‘ì§€

        submitBtn.addEventListener("click", async () => {

            // ğŸ”¥ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ëŒ“ê¸€ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
            const content = document.getElementById("comment-content").value;

            // ğŸ”¥ í˜„ì¬ ê²Œì‹œê¸€ IDë¥¼ Thymeleafì—ì„œ ì§ì ‘ ì‚½ì…
            const postId = [[${post.id}]];

            // ğŸ”¥ ë‚´ìš©ì´ ë¹„ì–´ ìˆìœ¼ë©´ ê²½ê³  í›„ ì¤‘ë‹¨
            if (!content.trim()) {
                alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            // ğŸ”¥ ì„œë²„ì— ëŒ“ê¸€ ì €ì¥ ìš”ì²­ (AJAX)
            // fetch() â†’ /content/comment ë¡œ JSON ë°ì´í„° ì „ë‹¬
            const response = await fetch("/content/comment", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    postId: postId,   // ì–´ë–¤ ê²Œì‹œê¸€ì¸ì§€
                    content: content  // ëŒ“ê¸€ ë‚´ìš©
                })
            });

            // ğŸ”¥ ì„œë²„ì—ì„œ ë°˜í™˜í•œ ë¬¸ìì—´ í™•ì¸ ("SUCCESS" / "NOT_LOGIN" / "FAIL")
            const result = await response.text();

            // ğŸ”¥ ê²°ê³¼ì— ë”°ë¼ ì•ˆë‚´ ë©”ì‹œì§€ ì¶œë ¥
            if (result === "SUCCESS") {
                alert("ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload(); // ìƒˆë¡œê³ ì¹¨ â†’ ëŒ“ê¸€ ëª©ë¡ ì—…ë°ì´íŠ¸
            } else if (result === "NOT_LOGIN") {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            } else {
                alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");
            }
        });
    });
</script>


<!-- footer -->
<th:block th:replace="content/layout/footer :: footer"></th:block>
