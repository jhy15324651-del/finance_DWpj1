<!-- =======================
      HEADER
======================= -->
<th:block th:replace="content/layout/header :: header"></th:block>
<th:block th:replace="content/layout/header :: bodyheader"></th:block>

<div class="post-detail-container">

    <!-- =======================
          ì œëª©
    ======================== -->
    <h1 class="post-detail-title" th:text="${post.title}"></h1>

    <!-- ë‚ ì§œ Â· ì¡°íšŒìˆ˜ + ì‘ì„±ì -->
    <div class="post-detail-meta"
         style="display:flex; justify-content:space-between; align-items:center;">

        <!-- ë‚ ì§œ + ì¡°íšŒìˆ˜ -->
        <div>
            <span th:text="${#temporals.format(post.createdDate, 'yyyy.MM.dd')}"></span>
            <span class="view-text">
                Â· ì¡°íšŒìˆ˜ <span th:text="${post.viewCount}"></span>
            </span>
        </div>

        <!-- ì‘ì„±ì -->
        <div>
            <b th:text="${post.writer != null ? post.writer : 'ìµëª…'}"></b>
        </div>
    </div>


    <!-- =======================
          ì´ë¯¸ì§€
    ======================== -->
    <div th:if="${post.imgUrl}" class="post-image-box">
        <img th:src="${post.imgUrl}" class="post-image">
    </div>

    <!-- =======================
          ë³¸ë¬¸
    ======================== -->
    <div class="post-detail-content" th:utext="${post.content}"></div>

    <!-- =======================
          í•´ì‹œíƒœê·¸
    ======================== -->
    <div class="post-hashtags"
         th:if="${post.hashtags != null and #strings.length(post.hashtags) > 0}">
        <span th:each="tag : ${#strings.arraySplit(post.hashtags, ' ')}">
            <a th:href="@{/content/category(keyword=${tag})}"
               class="tag-item tag-badge"
               th:text="${tag}">
            </a>
        </span>
    </div>

    <!-- ===========================
         ê²Œì‹œê¸€ ìˆ˜ì •/ì‚­ì œ (ì‘ì„±ìë§Œ)
    ============================ -->
    <div class="post-edit-buttons"
         th:if="${nickname != null and post.writer == nickname}"
         style="text-align:right; margin:15px 0 25px 0;">

        <!-- ìˆ˜ì • -->
        <a th:href="@{/content/edit/{id}(id=${post.id})}"
           class="btn btn-outline-primary"
           style="margin-right:10px;">
            ìˆ˜ì •
        </a>

        <!-- ì‚­ì œ -->
        <a th:href="@{/content/delete/{id}(id=${post.id})}"
           class="btn btn-outline-danger"
           onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
            ì‚­ì œ
        </a>
    </div>


    <!-- =======================
          ëŒ“ê¸€ ì˜ì—­
    ======================== -->
    <div class="comment-section">
        <h3 class="comment-title">ëŒ“ê¸€</h3>

        <div class="comment-list">

            <!-- ëŒ“ê¸€ ì¶œë ¥ -->
            <div th:each="c : ${comments}" class="comment-item-box">

                <!-- ì¼ë°˜ ëŒ“ê¸€ -->
                <div th:if="${c.parentId == null}">
                    <div class="comment-header">
                        <b class="comment-writer" th:text="${c.writer}"></b>
                        <span class="comment-date"
                              th:text="${#temporals.format(c.createdDate,'yyyy-MM-dd HH:mm')}"></span>
                    </div>

                    <div class="comment-text" th:text="${c.content}"></div>

                    <!-- ğŸ”¥ ëŒ“ê¸€ ì•¡ì…˜ ë²„íŠ¼ (ìˆ˜ì •/ì‚­ì œ) -->
                    <div class="comment-actions">

                        <!-- ëŒ“ê¸€ ì‘ì„±ìë§Œ ìˆ˜ì • -->
                        <button th:if="${nickname == c.writer}"
                                class="comment-edit-btn"
                                th:attr="data-id=${c.id}">
                            ìˆ˜ì •
                        </button>

                        <!-- ëŒ“ê¸€ ì‘ì„±ì OR ê²Œì‹œê¸€ ì‘ì„±ìë§Œ ì‚­ì œ -->
                        <button th:if="${nickname == c.writer || nickname == post.writer}"
                                class="comment-delete-btn"
                                th:attr="data-id=${c.id}">
                            ì‚­ì œ
                        </button>

                    </div>
                </div>

                <!-- ëŒ€ëŒ“ê¸€ (êµ¬ì¡° ë™ì¼, ë””ìì¸ë§Œ ì°¨ì´) -->
                <div th:if="${c.parentId != null}" class="reply-item">

                    <div class="comment-header">
                        â†³ <b class="comment-writer" th:text="${c.writer}"></b>
                        <span class="comment-date"
                              th:text="${#temporals.format(c.createdDate,'yyyy-MM-dd HH:mm')}"></span>
                    </div>

                    <div class="comment-text" th:text="${c.content}"></div>

                    <div class="comment-actions">

                        <!-- ëŒ€ëŒ“ê¸€ë„ ê¶Œí•œ ë™ì¼ ì ìš© -->
                        <button th:if="${nickname == c.writer}"
                                class="comment-edit-btn"
                                th:attr="data-id=${c.id}">
                            ìˆ˜ì •
                        </button>

                        <button th:if="${nickname == c.writer || nickname == post.writer}"
                                class="comment-delete-btn"
                                th:attr="data-id=${c.id}">
                            ì‚­ì œ
                        </button>

                    </div>

                </div>

            </div>
        </div>


        <!-- =======================
              ëŒ“ê¸€ ì‘ì„± ì˜ì—­
        ======================== -->
        <div class="comment-write-box">

            <h4 class="comment-write-title">ëŒ“ê¸€ ì‘ì„±</h4>

            <!-- ë¡œê·¸ì¸ x -->
            <div th:if="${nickname == null}" class="comment-login-required">
                <p>ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="/user/login">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            </div>

            <!-- ë¡œê·¸ì¸ O -->
            <div th:if="${nickname != null}" class="comment-write-row">

                <div class="comment-nickname-box">
                    <b>ì‘ì„±ì: </b> <span th:text="${nickname}"></span>
                </div>

                <textarea id="comment-content" class="comment-textarea"
                          placeholder="íƒ€ì¸ì„ ë¹„ë°©í•˜ê±°ë‚˜ ëª…ì˜ˆë¥¼ í›¼ì†í•˜ëŠ” ëŒ“ê¸€ì€ ì œì¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤."></textarea>

                <div class="comment-submit-wrap">
                    <button id="comment-submit" class="comment-submit-btn">ë“±ë¡</button>
                </div>
            </div>
        </div>

    </div> <!-- ëŒ“ê¸€ ì„¹ì…˜ ì¢…ë£Œ -->


    <!-- =======================
         ëª©ë¡ / í™ˆ ë²„íŠ¼
    ======================== -->
    <div class="detail-btn-container">
        <a th:href="@{/content/category(page=${page}, keyword=${keyword}, searchType=${searchType})}"
           class="btn btn-outline-secondary detail-btn">
            ëª©ë¡ìœ¼ë¡œ
        </a>

        <a th:href="@{/content/}"
           class="btn btn-outline-secondary detail-btn">
            í™ˆìœ¼ë¡œ
        </a>
    </div>

</div> <!-- post-detail-container END -->


<!-- ===========================
     ëŒ“ê¸€ ê´€ë ¨ AJAX SCRIPT
=========================== -->
<script th:inline="javascript">

    /* --------------------------
       1) ëŒ“ê¸€ ì‘ì„±
    --------------------------- */
    document.addEventListener("DOMContentLoaded", function () {

        const submitBtn = document.getElementById("comment-submit");
        if (submitBtn) {

            submitBtn.addEventListener("click", async () => {
                const content = document.getElementById("comment-content").value;
                const postId = [[${post.id}]];

                if (!content.trim()) {
                    alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                const response = await fetch("/content/comment", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({postId: postId, content: content})
                });

                const result = await response.text();

                if (result === "SUCCESS") {
                    alert("ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.reload();
                } else if (result === "NOT_LOGIN") {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                } else {
                    alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");
                }
            });
        }

        /* --------------------------
           2) ëŒ“ê¸€ ì‚­ì œ
        --------------------------- */
        document.querySelectorAll(".comment-delete-btn").forEach(btn => {
            btn.addEventListener("click", async () => {

                const id = btn.dataset.id;
                if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

                const res = await fetch(`/content/comment/${id}`, {method: "DELETE"});
                const result = await res.text();

                if (result === "SUCCESS") location.reload();
                else if (result === "NO_PERMISSION") alert("ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                else alert("ì‚­ì œ ì‹¤íŒ¨");
            });
        });

        /* --------------------------
           3) ëŒ“ê¸€ ìˆ˜ì •
        --------------------------- */
        document.querySelectorAll(".comment-edit-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const id = btn.dataset.id;
                const box = btn.closest(".comment-item-box");
                const contentDiv = box.querySelector(".comment-text");

                const oldText = contentDiv.innerText;

                // ê¸°ì¡´ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                box.querySelectorAll(".comment-actions button").forEach(b => b.style.display = "none");

                // ìˆ˜ì •ëª¨ë“œ UIë¡œ êµì²´
                contentDiv.innerHTML = `
            <textarea class="edit-area">${oldText}</textarea>
            <div class="edit-action-wrapper">
                <button class="save-edit-btn">ì €ì¥</button>
                <button class="cancel-edit-btn">ì·¨ì†Œ</button>
            </div>
        `;

                // ì €ì¥ ë²„íŠ¼ í´ë¦­
                contentDiv.querySelector(".save-edit-btn").addEventListener("click", async () => {
                    const newText = contentDiv.querySelector(".edit-area").value;

                    const res = await fetch(`/content/comment/${id}`, {
                        method: "PUT",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({content: newText})
                    });

                    const result = await res.text();

                    if (result === "SUCCESS") location.reload();
                    else alert("ìˆ˜ì • ì‹¤íŒ¨");
                });

                // ì·¨ì†Œ ë²„íŠ¼ â†’ ì›ë˜ UI ë³µêµ¬
                contentDiv.querySelector(".cancel-edit-btn").addEventListener("click", () => {
                    location.reload();
                });
            });
        });

    });
</script>

<style>
    /* ìˆ˜ì •,ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .comment-edit-btn,
    .comment-delete-btn {
        padding: 6px 14px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        border: none;
    }

    .comment-edit-btn {
        background: #4e73df;
        color: #fff;
    }

    .comment-edit-btn:hover {
        background: #3b5cc4;
    }

    .comment-delete-btn:hover {
        background: #cacaca;
    }

</style>


<!-- footer -->
<th:block th:replace="content/layout/footer :: footer"></th:block>
