<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:fragment="header-main">
    <meta charset="UTF-8">
    <title>Finance Review - Content</title>

    <!-- Bootstrap -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <!-- ê³µí†µ CSS (NEW) -->
    <link rel="stylesheet" th:href="@{/css/common.css}">

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/content/content-review.css}">
</head>

<body th:fragment="bodyheader">

<!-- âœ… í†µì¼ëœ í—¤ë” ì ìš© -->
<nav class="common-navbar">
    <div class="common-navbar-content">
        <!-- ë¡œê³  (ì¢Œì¸¡) -->
        <div class="common-logo" onclick="location.href='/'">
            <img src="/img/snn_logo.png" alt="SNN - Signal Not Noise" />
        </div>

        <!-- ë©”ë‰´ (ì¤‘ì•™/ì¢Œì¸¡) -->
            <div class="common-nav-menu">
                <a th:href="@{/content/home}">ì½˜í…ì¸ ë¦¬ë·°</a>
                <a th:href="@{/stock/chart}">ì¢…ëª©ì°¨íŠ¸&í† ë¡ ë°©</a>
                <a th:href="@{/news}">ë‰´ìŠ¤&íŠ¸ìœ„í„°</a>
                <a th:href="@{/portfolio}">í¬íŠ¸í´ë¦¬ì˜¤&íˆ¬ììë¹„êµ</a>
            </div>

        <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ (ìš°ì¸¡) -->
        <div class="common-nav-buttons">

            <!-- ğŸ”” ì•Œë¦¼ ì•„ì´ì½˜ (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ í‘œì‹œ) -->
            <div class="notification-wrapper"
                 sec:authorize="isAuthenticated()">

                <!-- ì¢… ì•„ì´ì½˜ -->
                <div class="notification-bell" id="notificationBell">
                    ğŸ””
                    <!-- ì•ˆ ì½ì€ ì•Œë¦¼ ê°œìˆ˜ -->
                    <span class="notification-badge"
                          id="notificationCount">0</span>
                </div>

                <!-- ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ (ì§€ê¸ˆì€ ë¹„ì›Œë‘ ) -->
                <div class="notification-dropdown"
                     id="notificationDropdown">
                    <!-- ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ ì±„ì›€ -->
                </div>
            </div>

            <!-- ë¡œê·¸ì¸ ì „ -->
            <div sec:authorize="!isAuthenticated()" style="display: flex; gap: 10px;">
                <button class="btn-common btn-outline" onclick="location.href='/user/login'">ë¡œê·¸ì¸</button>
                <button class="btn-common-primary" onclick="location.href='/user/signup'">íšŒì›ê°€ì…</button>
            </div>

            <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ -->
            <div sec:authorize="hasRole('ADMIN')" style="display: flex; gap: 10px; align-items: center;">
                <span style="color: #667eea; font-weight: 600;">
                    <span th:text="${#authentication?.principal?.nickname != null ? #authentication.principal.nickname : #authentication.name}"></span>ë‹˜ (ê´€ë¦¬ì)
                </span>
                <button class="btn-common btn-outline" onclick="location.href='/admin'">ê´€ë¦¬ì í˜ì´ì§€</button>
                <button class="btn-common-primary" onclick="location.href='/user/logout'">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <!-- ì¼ë°˜ ì‚¬ìš©ì ë¡œê·¸ì¸ -->
            <div sec:authorize="hasRole('USER') and !hasRole('ADMIN')" style="display: flex; gap: 10px; align-items: center;">
                <span style="color: #667eea; font-weight: 600;">
                    <span th:text="${#authentication?.principal?.nickname != null ? #authentication.principal.nickname : #authentication.name}"></span>ë‹˜
                </span>
                <button class="btn-common btn-outline" onclick="location.href='/user/mypage'">ë§ˆì´í˜ì´ì§€</button>
                <button class="btn-common-primary" onclick="location.href='/user/logout'">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>
</nav>


<script>
    document.addEventListener("DOMContentLoaded", () => {

        const badge = document.getElementById("notificationCount");
        const bell = document.getElementById("notificationBell");
        const dropdown = document.getElementById("notificationDropdown");

        if (!badge || !bell || !dropdown) return;

        /* =========================
           ğŸ”” ì•ˆ ì½ì€ ì•Œë¦¼ ê°œìˆ˜ ì¡°íšŒ
        ========================= */
        fetch("/api/notifications/unread-count")
            .then(res => res.json())
            .then(count => {
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove("hidden");
                } else {
                    badge.classList.add("hidden");
                }
            })
            .catch(() => badge.classList.add("hidden"));

        /* =========================
           ğŸ”” ì¢… í´ë¦­ â†’ ë“œë¡­ë‹¤ìš´ í† ê¸€
        ========================= */
        bell.addEventListener("click", (e) => {
            e.stopPropagation();
            dropdown.classList.toggle("open");

            if (dropdown.classList.contains("open")) {
                loadNotifications();
            }
        });

        /* ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸° */
        document.addEventListener("click", () => {
            dropdown.classList.remove("open");
        });

        /* =========================
           ğŸ”” ìµœì‹  ì•Œë¦¼ ë¡œë“œ (ì•ˆ ì½ì€ ì•Œë¦¼ë§Œ)
        ========================= */
        function loadNotifications() {
            fetch("/api/notifications/latest")
                .then(res => res.json())
                .then(list => renderNotifications(list))
                .catch(() => {
                    dropdown.innerHTML = `
                    <div class="notification-empty">
                        ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤
                    </div>
                `;
                });
        }

        /* =========================
           ğŸ”” ì•Œë¦¼ ë Œë”ë§
        ========================= */
        function renderNotifications(list) {

            let html = "";

            if (list.length === 0) {
                html += `
                <div class="notification-empty">
                    ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤
                </div>
            `;
            } else {
                html += list.map(n => `
                <div class="notification-item"
                     data-id="${n.id}"
                     data-url="${n.targetUrl}">
                    <div class="notification-message">
                        ${n.message}
                    </div>
                    <div class="notification-date">
                        ${n.createdDate.replace("T", " ").substring(0, 16)}
                    </div>
                </div>
            `).join("");
            }

            /* ğŸ”½ í•˜ë‹¨: ì „ì²´ ì•Œë¦¼ ë³´ê¸° */
            html += `
            <div class="notification-footer">
                <a href="/notifications">ì „ì²´ ì•Œë¦¼ ë³´ê¸° â†’</a>
            </div>
        `;

            dropdown.innerHTML = html;

            /* =========================
               ğŸ”” ì•Œë¦¼ í´ë¦­ â†’ ì½ìŒ ì²˜ë¦¬ + ì´ë™
            ========================= */
            dropdown.querySelectorAll(".notification-item")
                .forEach(item => {
                    item.addEventListener("click", (e) => {
                        e.stopPropagation();

                        const id = item.dataset.id;
                        const url = item.dataset.url;

                        // ì½ìŒ ì²˜ë¦¬ (fire & forget)
                        fetch(`/api/notifications/${id}/read`, {
                            method: "POST"
                        });

                        // í˜ì´ì§€ ì´ë™
                        window.location.href = url;
                    });
                });
        }
    });
</script>


