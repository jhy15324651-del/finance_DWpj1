<th:block th:replace="content/layout/header :: header"></th:block>
<th:block th:replace="content/layout/header :: bodyheader"></th:block>

<div class="write-container">
    <h2>ê²Œì‹œê¸€ ìˆ˜ì •</h2>

    <form class="write-form"
          th:action="@{/content/edit/{id}(id=${post.id})}"
          method="post"
          enctype="multipart/form-data">

        <!-- ì œëª© -->
        <label>ì œëª©</label>
        <input type="text" name="title" th:value="${post.title}" required>

        <!-- Quill CSS -->
        <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

        <!-- ë³¸ë¬¸ (Quill Editor) -->
        <label>ë³¸ë¬¸</label>
        <div id="editor-container" style="height: 400px;"></div>

        <!-- ì„œë²„ë¡œ ë³´ë‚¼ ë³¸ë¬¸ -->
        <input type="hidden" id="content-hidden" name="content">

        <!-- í•´ì‹œíƒœê·¸ -->
        <label>í•´ì‹œíƒœê·¸</label>
        <input type="text" name="hashtags"
               th:value="${post.hashtags}"
               placeholder="#ì›ìœ  #ì—”ë¹„ë””ì•„ #ê²½ì œ">

        <!-- ë²„íŠ¼ -->
        <div style="text-align:center; margin-top:20px;">
            <button type="submit" class="btn-submit">ìˆ˜ì •í•˜ê¸°</button>
            <a th:href="@{/content/post/{id}(id=${post.id})}" class="btn-cancel">ëŒì•„ê°€ê¸°</a>
        </div>

        <!-- ì‚­ì œëœ ê¸€ì¼ ë•Œë§Œ ë¦¬í¬ìŠ¤íŠ¸ ë²„íŠ¼ í‘œì‹œ -->
        <div th:if="${post.isDeleted}" style="text-align:center; margin-top:10px;">
            <a th:href="@{/content/restore/{id}(id=${post.id})}"
               class="btn-restore">ê²Œì‹œê¸€ ë³µêµ¬í•˜ê¸°</a>
        </div>

    </form>
</div>

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<!-- ğŸ”¥ Thymeleaf ë³€ìˆ˜ ì•ˆì „í•˜ê²Œ JSì— ì „ë‹¬ -->
<script th:inline="javascript">

    /* ê¸°ì¡´ ë³¸ë¬¸ HTML */
    var originalHtml = /*[[${post.content}]]*/ "";

    /* ì‘ì„± í˜ì´ì§€ì™€ ë™ì¼í•œ íˆ´ë°” êµ¬ì„± */
    var toolbarOptions = [
        ['bold', 'italic', 'underline'],
        [{ 'header': 1 }, { 'header': 2 }],
        ['image']
    ];

    /* Quill ì—ë””í„° ìƒì„± */
    var quill = new Quill('#editor-container', {
        theme: 'snow',
        placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...',
        modules: {
            toolbar: {
                container: toolbarOptions,
                handlers: {
                    image: function () {
                        selectLocalImage();
                    }
                }
            }
        }
    });

    /* ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¸°ëŠ¥ */
    function selectLocalImage() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.click();

        input.onchange = () => {
            const file = input.files[0];
            saveToServer(file);
        };
    }

    function saveToServer(file) {
        const formData = new FormData();
        formData.append("file", file);

        fetch('/content/uploadImage', {
            method: "POST",
            body: formData
        })
            .then(res => res.text())
            .then(url => {
                let range = quill.getSelection(true);
                quill.insertEmbed(range.index, 'image', url);
            })
            .catch(err => {
                console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨", err);
            });
    }

    /* ğŸ”¥ ê¸°ì¡´ HTML â†’ Delta ë³€í™˜ í›„ Quillì— ì‚½ì… */
    var delta = quill.clipboard.convert(originalHtml);
    quill.setContents(delta, 'silent');

    /* ğŸ”¥ ì œì¶œ ì‹œ Hidden inputì— HTML ì‚½ì… */
    document.querySelector(".write-form").addEventListener("submit", function () {
        document.querySelector("#content-hidden").value = quill.root.innerHTML;
    });

</script>

<style>
    /* ë¦¬í¬ìŠ¤íŠ¸ ë²„íŠ¼ */
    .btn-restore {
        display: inline-block;
        padding: 8px 18px;
        background-color: #4caf50;
        color: white;
        border-radius: 6px;
        font-size: 14px;
        text-decoration: none;
        margin-top: 10px;
    }
    .btn-restore:hover {
        background-color: #3e8e41;
    }
</style>


<th:block th:replace="content/layout/footer :: footer"></th:block>
